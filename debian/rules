#!/usr/bin/make -f
#-*- makefile -*-
# Made with the aid of dh_make, by Craig Small
# Sample debian/rules that uses debhelper. GNU copyright 1997 by Joey Hess.
# Some lines taken from debmake, by Christoph Lameter.

versions=2.1 2.2 2.3

build: build-stamp
build-stamp:
	set -e; for version in $(versions); \
		do /usr/bin/python$$version setup.py build; \
	done
	touch build-stamp

clean:
	rm -f build-stamp install-stamp
	rm -rf build
	find . -name "*.pyc" |xargs -r rm
	# Add here commands to clean up after the build process.
	rm -rf debian/python*-twisted debian/python*-twisted-bin debian/twisted-doc debian/twisted-quotes
	rm -rf debian/files debian/substvars


install: install-stamp
install-stamp: build-stamp 
	chmod +x debian/scripts/*
	set -e; for version in $(versions); \
		do rm -rf debian/python$$version-twisted; \
		install -d debian/python$$version-twisted; \
		/usr/bin/python$$version setup.py install \
                   --no-compile --root debian/python$$version-twisted; \
		debian/scripts/install $$version; \
		install -d debian/python$$version-twisted-bin/usr/share/doc/python$$version-twisted-bin/; \
		install -d debian/python$$version-twisted-bin/DEBIAN; \
		install -m 644 debian/copyright \
		              debian/python$$version-twisted-bin/usr/share/doc/python$$version-twisted-bin;\
		install -m 644 debian/changelog \
				debian/python$$version-twisted-bin/usr/share/doc/python$$version-twisted-bin/changelog.Debian;\
		gzip -9 debian/python$$version-twisted-bin/usr/share/doc/python$$version-twisted-bin/changelog.Debian;\
		for file in `find debian/python$$version-twisted -name "*.so"`;\
			do target=`echo $$file | sed 's/twisted/twisted-bin/'`;\
			if [ ! -d `dirname $$target` ]; then\
				install -d `dirname $$target`; \
			fi; \
			mv $$file $$target; \
		done; \
	done
	debian/scripts/defaultpy 2.2

	install -d debian/twisted-doc/DEBIAN/
	install -d debian/twisted-doc/usr/share/doc/twisted-doc/
	install -d debian/twisted-doc/usr/share/doc/twisted-doc/examples
	install -d debian/twisted-doc/usr/share/doc/twisted-doc/howto
	install -d debian/twisted-doc/usr/share/doc/twisted-doc/specifications
	install -d debian/twisted-doc/usr/share/doc/twisted-doc/img
	install -d debian/twisted-doc/usr/share/doc/twisted-doc/api
	install -m 644 debian/copyright \
	               debian/twisted-doc/usr/share/doc/twisted-doc/
	install -m 644 debian/changelog \
	               debian/twisted-doc/usr/share/doc/twisted-doc/changelog.Debian
	gzip -9 debian/twisted-doc/usr/share/doc/twisted-doc/changelog.Debian
	install -m 644 doc/howto/*.html \
	               debian/twisted-doc/usr/share/doc/twisted-doc/howto/
	cp -ar doc/howto/listings/ \
	               debian/twisted-doc/usr/share/doc/twisted-doc/howto/
	install -m 644 doc/specifications/*.html \
	               debian/twisted-doc/usr/share/doc/twisted-doc/specifications/
	install -m 644 doc/img/*.{png,bmp} \
	               debian/twisted-doc/usr/share/doc/twisted-doc/img/
	cp -ar doc/api/* debian/twisted-doc/usr/share/doc/twisted-doc/
	install -m 644  doc/examples/*.py \
	                debian/twisted-doc/usr/share/doc/twisted-doc/examples/

	install -d debian/python-twisted/usr/share/doc/python-twisted
	install -d debian/python-twisted/DEBIAN
	install -m 644 debian/copyright \
	               debian/python-twisted/usr/share/doc/python-twisted/
	install -m 644 debian/changelog \
	               debian/python-twisted/usr/share/doc/python-twisted/changelog.Debian
	gzip -9 debian/python-twisted/usr/share/doc/python-twisted/changelog.Debian
	install -m 644 debian/python-twisted.README.Debian \
	               debian/python-twisted/usr/share/doc/python-twisted/README.Debian

	install -d debian/twisted/usr/share/doc/twisted
	install -d debian/twisted/DEBIAN
	install -m 644 debian/copyright \
	               debian/twisted/usr/share/doc/twisted/
	install -m 644 debian/changelog \
	               debian/twisted/usr/share/doc/twisted/changelog.Debian
	gzip -9 debian/twisted/usr/share/doc/twisted/changelog.Debian

	install -d debian/twisted-quotes/usr/share/doc/twisted-quotes
	install -d debian/twisted-quotes/DEBIAN
	install -m 644 debian/copyright \
	               debian/twisted-quotes/usr/share/doc/twisted-quotes/
	install -m 644 debian/changelog \
	               debian/twisted-quotes/usr/share/doc/twisted-quotes/changelog.Debian
	gzip -9 debian/twisted-quotes/usr/share/doc/twisted-quotes/changelog.Debian
	install -d debian/twisted-quotes/usr/share/games/fortunes/
	install -m 644 doc/fun/Twisted.Quotes \
	               debian/twisted-quotes/usr/share/games/fortunes/twisted-quotes
	strfile debian/twisted-quotes/usr/share/games/fortunes/twisted-quotes
	touch install-stamp


binary-indep: build install
	dpkg-gencontrol -isp -ptwisted-doc -Pdebian/twisted-doc
	chown -R root.root debian/twisted-doc
	chmod -R go=rX debian/twisted-doc
	dpkg --build debian/twisted-doc ..

	dpkg-gencontrol -isp -ptwisted-quotes -Pdebian/twisted-quotes
	chown -R root.root debian/twisted-quotes
	chmod -R go=rX debian/twisted-quotes
	dpkg --build debian/twisted-quotes ..

	dpkg-gencontrol -isp -ptwisted -Pdebian/twisted
	chown -R root.root debian/twisted
	chmod -R go=rX debian/twisted
	dpkg --build debian/twisted ..

	dpkg-gencontrol -isp -ppython-twisted -Pdebian/python-twisted
	chown -R root.root debian/python-twisted
	chmod -R go=rX debian/python-twisted
	dpkg --build debian/python-twisted ..

	dpkg-gencontrol -isp -ppython2.1-twisted -Pdebian/python2.1-twisted
	chown -R root.root debian/python2.1-twisted
	chmod -R go=rX debian/python2.1-twisted
	dpkg --build debian/python2.1-twisted ..

	dpkg-gencontrol -isp -ppython2.2-twisted -Pdebian/python2.2-twisted
	chown -R root.root debian/python2.2-twisted
	chmod -R go=rX debian/python2.2-twisted
	dpkg --build debian/python2.2-twisted ..

	chown -R root.root debian/python2.3-twisted
	chmod -R go=rX debian/python2.3-twisted
	dpkg --build debian/python2.3-twisted ..


binary-arch: build install
	find debian -name "*.so" | xargs -n 1 dpkg-shlibdeps

	dpkg-gencontrol -isp -ppython2.1-twisted-bin -Pdebian/python2.1-twisted-bin
	chown -R root.root debian/python2.1-twisted-bin
	chmod -R go=rX debian/python2.1-twisted-bin
	dpkg --build debian/python2.1-twisted-bin ..

	dpkg-gencontrol -isp -ppython2.2-twisted-bin -Pdebian/python2.2-twisted-bin
	chown -R root.root debian/python2.2-twisted-bin
	chmod -R go=rX debian/python2.2-twisted-bin
	dpkg --build debian/python2.2-twisted-bin ..

	dpkg-gencontrol -isp -ppython2.3-twisted-bin -Pdebian/python2.3-twisted-bin
	chown -R root.root debian/python2.3-twisted-bin
	chmod -R go=rX debian/python2.3-twisted-bin
	dpkg --build debian/python2.3-twisted-bin ..

binary: binary-indep binary-arch
.PHONY: build clean binary-indep binary-arch binary install
