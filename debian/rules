#!/usr/bin/make -f

versions=$(shell grep '^Build-Depends:' debian/control | sed -e 's/^Build-Depends: //' -e 's/,//g' -e  's/-dev//g' -e 's/python//g' -e 's/fortune-mod//')

build: build-stamp
build-stamp:
	set -e; for version in $(versions); \
		do /usr/bin/python$$version setup.py build; \
	done
	touch build-stamp

clean:
	rm -f build-stamp install-stamp
	rm -rf build
	find . -name "*.pyc" |xargs -r rm
	# Add here commands to clean up after the build process.
	rm -rf debian/python*-twisted debian/python*-twisted-bin debian/twisted-doc debian/twisted-quotes debian/twisted debian/python*-twisted-conch
	rm -rf debian/files debian/substvars

DOC=usr/share/doc

install: install-stamp
install-stamp: build-stamp 
	chmod +x debian/scripts/*
	set -e; for version in $(versions); \
		do rm -rf debian/python$$version-twisted; \
		install -d debian/python$$version-twisted; \
		/usr/bin/python$$version setup.py install \
                   --no-compile --root debian/python$$version-twisted; \
		debian/scripts/install $$version; \
		binpackage=python$$version-twisted-bin;\
		install -d debian/$$binpackage/${DOC}/$$binpackage/;\
		install -d debian/$$binpackage/DEBIAN; \
		install -m 644 debian/copyright \
		      debian/$$binpackage/${DOC}/$$binpackage/; \
		install -m 644 debian/changelog \
		      debian/$$binpackage/${DOC}/$$binpackage/changelog.Debian;\
		gzip -9 debian/$$binpackage/${DOC}/$$binpackage/changelog.Debian;\
		for file in `find debian/python$$version-twisted -name "*.so"`;\
			do target=`echo $$file | sed 's/twisted/twisted-bin/'`;\
			if [ ! -d `dirname $$target` ]; then\
				install -d `dirname $$target`; \
			fi; \
			mv $$file $$target; \
		done; \
	done
	debian/scripts/defaultpy 2.2

	set -e; for version in $(versions); \
		do \
		package=python$$version-twisted-conch;\
		tpackage=python$$version-twisted;\
		dir=usr/lib/python$$version/site-packages;\
		install -d debian/$$package/${DOC}/$$package/;\
		install -d debian/$$package/DEBIAN; \
		install -m 644 debian/copyright \
		      debian/$$package/${DOC}/$$package/; \
		install -m 644 debian/changelog \
		      debian/$$package/${DOC}/$$package/changelog.Debian;\
		gzip -9 debian/$$package/${DOC}/$$package/changelog.Debian;\
		install -d debian/$$package/$$dir/twisted/scripts; \
		install -d debian/$$package/usr/bin; \
		install -d debian/$$package/usr/share/man/man1; \
		mv debian/$$tpackage/$$dir/twisted/conch \
		   debian/$$package/$$dir/twisted/;\
		mv debian/$$tpackage/$$dir/twisted/scripts/conch.py \
		   debian/$$package/$$dir/twisted/scripts;\
		mv debian/$$tpackage/usr/bin/conch* \
		   debian/$$package/usr/bin/; \
		mv debian/$$tpackage/usr/share/man/man1/conch* \
		   debian/$$package/usr/share/man/man1/; \
		for maint in postinst prerm; \
			do sed -e "s/@VERSION@/$$version/g" \
			       -e "s/twisted/twisted-conch/"\
			       -e "/update-menus/d" \
			debian/python-twisted.$$maint.in > \
			debian/$$package/DEBIAN/$$maint;\
		done;\
	done
		

	install -d debian/twisted-doc/DEBIAN/
	install -d debian/twisted-doc/usr/share/doc/twisted-doc/
	install -d debian/twisted-doc/usr/share/doc/twisted-doc/examples
	install -d debian/twisted-doc/usr/share/doc/twisted-doc/howto
	install -d debian/twisted-doc/usr/share/doc/twisted-doc/specifications
	install -d debian/twisted-doc/usr/share/doc/twisted-doc/img
	install -d debian/twisted-doc/usr/share/doc/twisted-doc/api
	install -m 644 debian/copyright \
	               debian/twisted-doc/usr/share/doc/twisted-doc/
	install -m 644 debian/changelog \
	               debian/twisted-doc/usr/share/doc/twisted-doc/changelog.Debian
	gzip -9 debian/twisted-doc/usr/share/doc/twisted-doc/changelog.Debian
	install -m 644 doc/howto/*.html \
	               debian/twisted-doc/usr/share/doc/twisted-doc/howto/
	cp -ar doc/howto/listings/ \
	               debian/twisted-doc/usr/share/doc/twisted-doc/howto/
	install -m 644 doc/specifications/*.html \
	               debian/twisted-doc/usr/share/doc/twisted-doc/specifications/
	install -m 644 doc/img/*.png \
	               debian/twisted-doc/usr/share/doc/twisted-doc/img/
	install -m 644 doc/img/*.bmp \
	               debian/twisted-doc/usr/share/doc/twisted-doc/img/
	cp -ar doc/api/* debian/twisted-doc/usr/share/doc/twisted-doc/api/
	install -m 644  doc/examples/*.py \
	                debian/twisted-doc/usr/share/doc/twisted-doc/examples/

	install -d debian/python-twisted/usr/share/doc/python-twisted
	install -d debian/python-twisted/DEBIAN
	install -m 644 debian/copyright \
	               debian/python-twisted/usr/share/doc/python-twisted/
	install -m 644 debian/changelog \
	               debian/python-twisted/usr/share/doc/python-twisted/changelog.Debian
	gzip -9 debian/python-twisted/usr/share/doc/python-twisted/changelog.Debian
	install -m 644 debian/python-twisted.README.Debian \
	               debian/python-twisted/usr/share/doc/python-twisted/README.Debian

	install -d debian/python-twisted-conch/usr/share/doc/python-twisted-conch
	install -d debian/python-twisted-conch/DEBIAN
	install -m 644 debian/copyright \
	               debian/python-twisted-conch/usr/share/doc/python-twisted-conch/
	install -m 644 debian/changelog \
	               debian/python-twisted-conch/usr/share/doc/python-twisted-conch/changelog.Debian
	gzip -9 debian/python-twisted-conch/usr/share/doc/python-twisted-conch/changelog.Debian

	install -d debian/twisted/usr/share/doc/twisted
	install -d debian/twisted/DEBIAN
	install -m 644 debian/copyright \
	               debian/twisted/usr/share/doc/twisted/
	install -m 644 debian/changelog \
	               debian/twisted/usr/share/doc/twisted/changelog.Debian
	gzip -9 debian/twisted/usr/share/doc/twisted/changelog.Debian

	install -d debian/twisted-quotes/usr/share/doc/twisted-quotes
	install -d debian/twisted-quotes/DEBIAN
	install -m 644 debian/copyright \
	               debian/twisted-quotes/usr/share/doc/twisted-quotes/
	install -m 644 debian/changelog \
	               debian/twisted-quotes/usr/share/doc/twisted-quotes/changelog.Debian
	gzip -9 debian/twisted-quotes/usr/share/doc/twisted-quotes/changelog.Debian
	install -d debian/twisted-quotes/usr/share/games/fortunes/
	install -m 644 doc/fun/Twisted.Quotes \
	               debian/twisted-quotes/usr/share/games/fortunes/twisted-quotes
	strfile debian/twisted-quotes/usr/share/games/fortunes/twisted-quotes
	touch install-stamp


binary-indep: build install
	dpkg-gencontrol -isp -ptwisted-doc -Pdebian/twisted-doc
	chown -R root.root debian/twisted-doc
	chmod -R go=rX debian/twisted-doc
	dpkg --build debian/twisted-doc ..

	dpkg-gencontrol -isp -ptwisted-quotes -Pdebian/twisted-quotes
	chown -R root.root debian/twisted-quotes
	chmod -R go=rX debian/twisted-quotes
	dpkg --build debian/twisted-quotes ..

	dpkg-gencontrol -isp -ptwisted -Pdebian/twisted
	chown -R root.root debian/twisted
	chmod -R go=rX debian/twisted
	dpkg --build debian/twisted ..

	dpkg-gencontrol -isp -ppython-twisted -Pdebian/python-twisted
	chown -R root.root debian/python-twisted
	chmod -R go=rX debian/python-twisted
	dpkg --build debian/python-twisted ..

	for ver in $(versions); \
	do dpkg-gencontrol -isp -ppython$$ver-twisted -Pdebian/python$$ver-twisted;\
	chown -R root.root debian/python$$ver-twisted;\
	chmod -R go=rX debian/python$$ver-twisted;\
	dpkg --build debian/python$$ver-twisted ..;\
	done

	for ver in $(versions); \
	do dpkg-gencontrol -isp -ppython$$ver-twisted-conch -Pdebian/python$$ver-twisted-conch;\
	chown -R root.root debian/python$$ver-twisted-conch;\
	chmod -R go=rX debian/python$$ver-twisted-conch;\
	dpkg --build debian/python$$ver-twisted-conch ..;\
	done

binary-arch: build install
	find debian -name "*.so" | xargs -n 1 dpkg-shlibdeps

	for ver in $(versions); \
	do dpkg-gencontrol -isp -ppython$$ver-twisted-bin -Pdebian/python$$ver-twisted-bin;\
	chown -R root.root debian/python$$ver-twisted-bin;\
	chmod -R go=rX debian/python$$ver-twisted-bin;\
	dpkg --build debian/python$$ver-twisted-bin ..;\
	done

binary: binary-indep binary-arch
.PHONY: build clean binary-indep binary-arch binary install
