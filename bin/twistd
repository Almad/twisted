#!/usr/bin/env python

# Twisted, the Framework of Your Internet
# Copyright (C) 2001 Matthew W. Lefkowitz
# 
# This library is free software; you can redistribute it and/or
# modify it under the terms of version 2.1 of the GNU Lesser General Public
# License as published by the Free Software Foundation.
# 
# This library is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
# Lesser General Public License for more details.
# 
# You should have received a copy of the GNU Lesser General Public
# License along with this library; if not, write to the Free Software
# Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA


"""
Usage: twistd [options]
Options:
     -t --threaded    use threads
     -q --quiet       be a little more quiet
     -n --nodaemon    don't daemonize
     -p --profile     run profiler
     -o --no_save     do not save state on shutdown
     -l --logfile     log to a specified file, - for stdout
                        (default twistd.log)
        --pidfile     use a pidfile
                        (default twistd.pid)
     -r --rundir      change to a supplied directory before running
                        (default .)
     -f --file        read the given .tap file
                        (default twistd.tap)
     -y --python      read an application from within a Python file
     -g --plugin      read config.tac from a plugin package, as with -y

This reads an twisted.internet.main.Application out of a file and runs it.
"""

### Twisted Preamble
# This makes sure that users don't have to set up their environment
# specially in order to run these programs from bin/.
import sys,os,string

if string.find(os.path.abspath(sys.argv[0]),'Twisted') != -1:
    sys.path.append(os.path.dirname(
        os.path.dirname(os.path.abspath(sys.argv[0]))))
### end of preamble

# System Imports
from cPickle import load
import traceback

# Twisted Imports
from twisted.python import usage, threadable, log
from twisted.persisted import styles

# Add plugin paths.
import twisted

systemPlugins = os.path.join(os.path.dirname(os.path.dirname(os.path.abspath(twisted.__file__))), 'plugins')
userPlugins = os.path.expanduser("~/TwistedPlugins")
confPlugins = os.path.expanduser('~/.twisted')
# Removed by Moshe's request
# currentPlugins = os.path.abspath("TwistedPlugins")
allPlugins = [systemPlugins, userPlugins, confPlugins] #, currentPlugins]
sys.path.extend(allPlugins)

# Load the servers.
# This will fix up accidental function definitions in evaluation spaces
# and the like.
initRun = 0
mainMod = sys.modules['__main__']

class EverythingEphemeral(styles.Ephemeral):
    def __getattr__(self, key):
        try:
            return getattr(mainMod, key)
        except AttributeError:
            if initRun:
                raise
            else:
                print "Warning!  Loading from __main__: %s" % key
                return styles.Ephemeral()


class ServerOptions(usage.Options):
    optFlags = [['nodaemon','n'],
                ['profile','p'],
                ['threaded','t'],
                ['quiet','q'],
                ['no_save','o']]
    optStrings = [['logfile','l',None],
                  ['file','f','twistd.tap'],
                  ['python','y',''],
                  ['pidfile','','twistd.pid'],
                  ['rundir','d','.']]

    def opt_plugin(self, pkgname):
        pkg = __import__(pkgname)
        self.python = os.path.join(os.path.dirname(os.path.abspath(pkg.__file__)), 'config.tac')

    opt_g = opt_plugin

try:
    config = ServerOptions()
    config.parseOptions()
except usage.error, ue:
    print __doc__
    print "%s: %s" % (sys.argv[0], ue)
    os._exit(1)

os.chdir(config.rundir)
sys.path.append(config.rundir)
threadable.init(config.threaded)

if os.path.exists(config.pidfile):
    try:
        pid = int(open(config.pidfile).read())
    except ValueError:
        sys.exit('Pidfile %s contains non numeric value' % config.pidfile)

    try:
        os.kill(pid, 0)
    except OSError:
        # The pid doesnt exists.
        if not config.quiet:
            print 'Removing stale pidfile %s' % config.pidfile
        os.remove(config.pidfile)
    else:
        sys.exit('A server is already running, PID %s' %  pid)

if config.logfile == '-':
    if not config.nodaemon:
        print 'daemons cannot log to stdout'
        os._exit(1)
    logFile = sys.stdout
elif config.nodaemon and not config.logfile:
    logFile = sys.stdout
else:
    logFile = open(config.logfile or 'twistd.log','ab+')

oldstdin = sys.stdin
oldstdout = sys.stdout
oldstderr = sys.stderr
log.startLogging(logFile)
sys.stdout.flush()

if not config.python:
    print "Loading %s..." % config.file
    sys.modules['__main__'] = EverythingEphemeral()
    application = load(open(config.file,'rb'))
    sys.modules['__main__'] = mainMod
    from twisted.internet import main
    main.theApplication = application
    styles.doUpgrade()
else:
    pyfile = os.path.abspath(config.python)
    print "Loading %s..." % pyfile
    dict = {'__file__': pyfile}
    execfile(pyfile, dict, dict)
    try:
        application = dict['application']
    except KeyError:
        log.msg('Python file %s did not produce an application.' % repr(pyfile))
        sys.exit()

print "Loaded."
initRun = 1

if not config.nodaemon:
    # Turn into a daemon.
    if os.fork():   # launch child and...
        os._exit(0) # kill off parent
    os.setsid()
    os.umask(0)
    oldstdin.close()
    oldstdout.close()
    oldstderr.close()

open(config.pidfile,'wb').write(str(os.getpid()))

try:
    if config.profile:
        import profile
        profile.run("application.run(%d)" % (not config.no_save))
    else:
        application.run(not config.no_save)
except:
    if config.nodaemon:
        file = oldstdout
    else:
        file = open("TWISTD-CRASH.log",'a')
    traceback.print_exc(file=file)
    file.flush()
os.unlink(config.pidfile)
print "Server Shut Down."
