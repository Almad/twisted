#!/usr/bin/env python

"""
Usage: mkrealityserver map.rpl map.spl

This will create a server set file, 'pump.spl' (suitable for usage
with Serve.py), from the given Twisted Reality map pickle.
"""

### Twisted Preamble
# This makes sure that users don't have to set up their environment
# specially in order to run these programs from bin/.
import sys,os,string

if string.find(os.path.abspath(sys.argv[0]),'Twisted') != -1:
    sys.path.append(os.path.dirname(
        os.path.dirname(os.path.abspath(sys.argv[0])))) 
    sys.path.append('.')
### end of preamble

from cPickle import load
from twisted.reality import plumbing, reality
from twisted.internet import tcp, main
from twisted.web import server
from twisted.spread import pb

mapname = sys.argv[1]

print 'Loading %s...' % mapname
sys.stdout.flush()
rdf = reality._default = load(open(mapname,'rb'))
print 'Loaded.'

spigot = plumbing.Spigot(rdf)
site = server.Site(plumbing.Web(rdf))
bf = pb.BrokerFactory()
bf.addService("reality", rdf)

app = main.Application("reality")
app.listenOn(8080, site)
app.listenOn(4040, spigot)
app.listenOn(8787, bf)
app.save()
print "Done."


