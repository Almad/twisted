<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
  <head>
    <title>Banana Protocol Specifications</title>
  </head>

  <body>
    <h1>Banana Protocol Specifications</h1>

    <h2>Introduction</h2>

    <p>
      Banana is an efficient, extendable protocol for sending and receiving s-expressions.
      A s-expression in this context is a list composed of byte strings, integers, 
      large integers, floats and/or s-expressions.
    </p>

    <h2>Banana Encodings</h2>

    <p>
      The banana protocol is a stream of data composed of elements. Each element has the
      following structure - first, the length of element encoded in base-128, least signficant
      bit first. For example length 4674 will be sent as <code>0x42 0x24</code>.
    </p>

    <p>
      Following the length is a delimiter byte, which tells us what kind of element this
      is. Depending on the element type, there will then follow the number of bytes specified
      in the length. The byte's high-bit will always be set, so that we can differentiate
      between it and the length (since the length bytes use 128-base, their high bit will
      never be set).
    </p>

    <h2>Element Types</h2>

    <p>
      Given a series of bytes that gave us length N, these are the different delimiter bytes:
    </p>

    <dl>
      <dt>List -- 0x80</dt>
      <dd>The following N bytes are a list of elements.</dd>

      <dt>Integer -- 0x81</dt>
      <dd>The value of this element is the positive integer N. Following bytes are not part of this element.</dd>

      <dt>String -- 0x82</dt>
      <dd>The following N bytes are a string element.</dd>

      <dt>Negative Integer -- 0x83</dt>
      <dd>The value of this element is the negative integer -N. Following bytes are not part of this element.</dd>

      <dt>Float - 0x84</dt>
      <dd>The next 8 bytes are the float encoded in IEEE 754 floating-point "double format" bit layout.
	No length bytes should have been defined.
      </dd>

      <dt>Large Integer -- 0x81 (optional)</dt>
      <dd>The value of this element is the positive large integer N. Following bytes are not part of this element.</dd>

      <dt>Large Negative Integer -- 0x83 (optional)</dt>
      <dd>The value of this element is the negative large integer -N. Following bytes are not part of this element.</dd>
    </dl>

    <p>
      Large integers do not need to be supported - they are intended for arbitary length integers.
      Regular integers types (positive and negative) are limited to 32-bit values.
    </p>

    <h3>Examples</h3>

    <p>
      Here are some examples of elements and their encodings:
    </p>

    <dl>
      <dt>1</dt>
      <dd><code>0x1 0x81</code></dd>
      <dt>-1</dt>
      <dd><code>0x1 0x83</code></dd>
      <dt>1.5</dt>
      <dd><code>0x84 0x3f 0xf8 0x0 0x0 0x0 0x0 0x0 0x0</code></dd>
      <dt>hello</dt>
      <dd><code>0x5 0x82 0x68 0x65 0x6c 0x6c 0x6f</code></dd>
      <dt>[]</dt>
      <dd><code>0x0 0x80</code></dd>
      <dt>[1, 23]</dt>
      <dd><code>0x2 0x80 0x1 0x81 0x17 0x81</code></dd>
      <dt>123456789123456789</dt>
      <dd><code>0x15 0x3e 0x41 0x66 0x3a 0x69 0x26 0x5b 0x1 0x85</code></dd>
      <dt>[1, ['hello']]</dt>
      <dd><code>0x2 0x80 0x1 0x81 0x1 0x80 0x5 0x82 0x68 0x65 0x6c 0x6c 0x6f</code></dd>
    </dl>

    <h2>Profiles</h2>
    
    <p>
      The Banana protocol is extendable. Therefore, it supports the concept of profiles. Profiles allow
      developers to extend the banana protocol, adding new element types, while still keeping backwards
      compatability with implementations that don't support the extensions. The profile used in each
      session is determined at the handshake stage (see below.)
    </p>

    <p>
      A profile is specified by a unique string. This specification defines two profiles - "none" and "pb".
      The "none" profile is the standard profile that should be supported by all Banana implementations.
      Additional profiles may be added in the future.
    </p>
    
    <h3>The "none" Profile</h3>

    <p>
      The "none" profile is identical to the delimiter types listed above. It is highly recommended
      that all Banana clients and servers support the "none" profile.
    </p>

    <h3>The "pb" Profile</h3>

    <p>
      The "pb" profile is intended for use with the Perspective Broker protocol, that runs on top
      of Banana. Basically, it converts commonly used PB strings into shorter versions, thus
      minimizing bandwidth usage. It does this by adding an additional delimiter byte, 0x87.
      This byte should not be prefixed by a length. It should be followed by a single byte, which
      tells us to which string element to convert it:
    </p>
    
    <dl>
      <dt>0x1</dt> <dd>'None'</dd>
      <dt>0x2</dt> <dd>'class'</dd>
      <dt>0x3</dt> <dd>'dereference'</dd>
      <dt>0x4</dt> <dd>'reference'</dd>
      <dt>0x5</dt> <dd>'dictionary'</dd>
      <dt>0x6</dt> <dd>'function'</dd>
      <dt>0x7</dt> <dd>'instance'</dd>
      <dt>0x8</dt> <dd>'list'</dd>
      <dt>0x9</dt> <dd>'module'</dd>
      <dt>0xa</dt> <dd>'persistent'</dd>
      <dt>0xb</dt> <dd>'tuple'</dd>
      <dt>0xc</dt> <dd>'unpersistable'</dd>
      <dt>0xd</dt> <dd>'copy'</dd>
      <dt>0xe</dt> <dd>'cache'</dd>
      <dt>0xf</dt> <dd>'cached'</dd>
      <dt>0x10</dt> <dd>'remote'</dd>
      <dt>0x11</dt> <dd>'local'</dd>
      <dt>0x12</dt> <dd>'lcache'</dd>
      <dt>0x13</dt> <dd>'version'</dd>
      <dt>0x14</dt> <dd>'login'</dd>
      <dt>0x15</dt> <dd>'password'</dd>
      <dt>0x16</dt> <dd>'challenge'</dd>
      <dt>0x17</dt> <dd>'logged_in'</dd>
      <dt>0x18</dt> <dd>'not_logged_in'</dd>
      <dt>0x19</dt> <dd>'cachemessage'</dd>
      <dt>0x1a</dt> <dd>'message'</dd>
      <dt>0x1b</dt> <dd>'answer'</dd>
      <dt>0x1c</dt> <dd>'error'</dd>
      <dt>0x1d</dt> <dd>'decref'</dd>
      <dt>0x1e</dt> <dd>'decache'</dd>
      <dt>0x1f</dt> <dd>'uncache'</dd>
      </dl>

    <h2>Protocol Handshake and Behaviour</h2>

    <p>
      The initiating side of the connection will be referred to as "client", and the other
      side as "server".
    </p>

    <p>
      Upon connection, the server will send the client a list of string elements, signifying
      the profiles it supports. It is recommended that "none" be included in this list. The client
      then sends the server a string from this list, telling the server which profile it wants to
      use. At this point the whole session will use this profile.
    </p>
    
    <p>
      Once a profile has been established, the two sides may start exchanging elements. There is no
      limitation on order or dependencies of messages. Any such limitation (e.g. "server can only
      send an element to client in response to a request from client") is application specific.
    </p>

    <p>
      Upon receiving illegal messages, failed handshakes, etc., a Banana client or server should
      close its connection.
    </p>

  </body>
</html>
