<?xml version="1.0"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <title>Debugging with Manhole</title>
  </head>

  <body>
    <h1>Debugging with Manhole</h1>

<h2>Creating the Manhole Service</h2>

<p>In order to create a manhole server, use a command like
<code class="shell">mktap manhole -u [username] -w [password]</code>.
If you've already got a <q>TAP</q> for a server, you can use the argument
<code class="shell">--append [tapname]</code> to
<code class="shell">mktap</code> to add a manhole service to that
<q>TAP</q>.</p>

<h2>Using the Manhole PB Client</h2>

<p>The second service offered by twisted.manhole is a Perspective Broker
-based server. This gives the client a remote reference to a
twisted.manhole.service.Service object, which offers remotely-callable
methods to evaluate Python code. With the rich remote-method-invocation
facilities provided by PB, however, much more is possible: the client can
ask to <q>watch</q> certain objects, and then will receive messages every time
that python object is changed. (this takes advantage of some twisted.python
code that <q>hooks</q> some functions, like .setattr). These features are
described in detail below.</p>

<p>With this in place and running, you're ready to connect with the manhole
client. This is a Gtk+-based GUI application named <code>manhole</code> that
gets installed along with the rest of twisted. Execute the command <code
class="shell">manhole</code> to start the client, and it will bring up a
dialog that asks for hostname, port number, Service name, username, and
password (and also <q>Perspective</q> but don't worry about that for now). Use
the default host/port of localhost/8787 to indicate where the
<code>twisted.manhole</code> service is listening, and use boss/sekrit for the
username and password. Use the default Service name <q>twisted.manhole</q>, and
leave the Perspective blank.</p>

<p> Click the <q>Log In</q> button to establish the connection, and you will be
greeted with a short message in a window with an output area in the top, and
an input area at the bottom. This is just like the python interpreter
accessed through the telnet shell, but with a different GUI. You can type
arbitrary python code into the input area and get the results in the output
area. Note that multi-line sequences are all sent together, so if you define
a function (or anything else that uses indentation to tell the interpreter
that you aren't finished yet), you'll need to type one additional Return to
tell the client to send off the code.</p>


<p>At this point, you can get access to the main <code class="API"
base="twisted.internet.app">Application</code> object just like you did
before with the telnet-based shell. You can use that to obtain the <code
class="API" base="twisted.spread.pb">Service</code> objects inside it, or
references to the <code class="API"
base="twisted.internet.protocol">Factory</code> objects that are listening
on TCP or UDP ports, by doing:</p>

<pre class="python-interpreter">
from twisted.internet import app
a = app.theApplication
service = a.getServiceNamed("manhole")
(port, factory, backlog, interface) = a.tcpPorts[0]
</pre>

<p>After that, you can do anything you want with those objects.</p>


<h2>Special Commands</h2>

<p>There are a few special commands so far that make debugging Twisted
objects really nice. These are <code>/browse</code> and <code>/watch</code>.
You can <code>/browse</code> any type of object, and it will give you some
nice information about that object in the <q>Spelunking</q> window that pops up
when <code>manhole</code> establishes a connection to the <code>manhole</code>
Service. <code>/watch</code>-ing an object adds hooks to the object,
allowing you to watch modifications to it in real time. Try the following in
the <code>manhole</code> window and watch what happens in the <q>Spelunking</q>
box (word wrapped for clarity):</p>

<pre class="python-interpreter">
/browse ["hello", "there"]
 <span class="manhole-output"
>&lt;ObjectLink of ["hello", "there"] type list&gt;:
  ['hello',
   'there',]
</span>

class A:
    def foo(self):
        self.x = 1

x = A()
/browse x
<span class="manhole-output">&lt;ObjectLink of x type instance&gt;:
  {members: {}
   class: 'A'
   methods: {}}
</span>

/watch x
 <span class="manhole-output"> &lt;ObjectLink of x type instance&gt;:
  {members: {}
   class: 'A'
   methods: {}}
</span>

x.foo()

<span class="manhole-output">&lt;ObjectLink of x type instance&gt;:
  {members: {x: 1}
   class: 'twisted.python.explorer.WatchingA8195574'
   methods:
     {foo:
        &lt;ObjectLink of x.foo type instance_method&gt;:
          {class: 'twisted.python.explorer.WatchingA8195574'
           self: '&lt;twisted.python.explorer.WatchingA8195574 instance at
                 0x8195574&gt;'
           doc:
             Pretend to be the method I replaced, and ring the bell.
                     
           line: 651
           signature:
             [{name: instance},
              {name: a
               list: 1},
              {name: kw
               keywords: 1},]
           file: /home/punck/cvs/Twisted/twisted/python/explorer.py
           name: __call__}
        }}

&lt;ObjectLink of x type instance&gt;:
  {members: {x: 1}
   class: 'twisted.python.explorer.WatchingA8195574'
   methods:
     {foo:
        &lt;ObjectLink of x.foo type instance_method&gt;:
          {class: 'twisted.python.explorer.WatchingA8195574'
           self: '&lt;twisted.python.explorer.WatchingA8195574 instance at
                 0x8195574&gt;'
           doc:
             Pretend to be the method I replaced, and ring the bell.
                     
           line: 651
           signature:
             [{name: instance},
              {name: a
               list: 1},
              {name: kw
               keywords: 1},]
           file: /home/punck/cvs/Twisted/twisted/python/explorer.py
           name: __call__}
        }}
</span>
   
</pre>

<p>TODO: <code>/watch</code> might be broken right now.</p>

<p>As you can see, <code>/watch</code> really gives you a lot of power (and
a lot of output, too -- hopefully we'll have a nice GUI display for this in
the future). The <code>/browse</code> and <code>/watch</code> functionality
is brought to you by the <code class="API">twisted.manhole.explorer</code>
module, which was written largely by Kevin Turner.</p>


<p>TODO: Add an example using <code
class="API">twisted.python.rebuild.rebuild</code>. This lets you tell your
application (remotely) to reload its classes, allowing you to upgrade a
running server without missing a beat.</p>

<p>Have fun!</p>

</body>
</html>
