<?xml version="1.0"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>Webizing your application with DOMTemplate</title>
</head>

<body>
<h1>Twisted Web's DOM Templates</h1>

<h2>Intro</h2>

<p>
Most templating systems provide commands that you embed in the HTML to repeat elements or include fragments from other files. This works fairly well for simple constructs; however, as soon as the programmer wants to make the logic even slightly more complicated, the templating system must be bent in ways it was never meant to be used.
</p>

<p>
The theory behind <code class="python">DOMTemplate</code> is that Python code, rather than special syntax in the HTML template, should be used to manipulate the structure of the HTML. <code class="python">DOMTemplate</code> uses the <a href="http://www.w3.org/DOM/">Document Object Model</a> (DOM), a <a href="http://www.w3.org/">W3</a> standard tree-based representation of an HTML document. The DOM provides an API that allows you to traverse nodes in the tree, examine their attributes, move, add, and delete them. For more information on using DOM in Python, see <a href="http://python.org/doc/lib/module-xml.dom.html">The xml.dom module documentation</a>.
</p>

<h2>Before we begin</h2>

<p>
You'll need to start a plain Twisted Web server.
</p>

<pre class="shell">
mktap web --path ~/public_html
twistd -f web.tap
</pre>

<p>
For more detailed information on this, see the guide to <a href="using-twistedweb.html">Installing and Using Twisted.Web</a>.
</p>

<p>
Once you do this you should be able to throw any files in <code class="shell">~/public_html</code>, and they'll be served on localhost:8080. Twisted Web also supports a number of special script types; the one we'll be using here is an <code class="shell">.rpy</code>, or <a href="using-twistedweb#ResourceScripts">Resource Script</a>.
</p>

<p>
A <a href="using-twistedweb#ResourceScripts">Resource Script</a> is simply a python file ending with the extension <code class="shell">.rpy</code>, which is required to create an instance of a (subclass of a) <code class="API">twisted.web.resource.Resource</code>. The <code class="python">Resource</code> subclass we'll be using in this example is, of course, <code class="python">DOMTemplate</code>.
</p>

<p>
Make sure the <code class="shell">TwistedQuotes</code> directory is on your <code class="shell">PYTHONPATH</code>, put <code class="py-filename">webquotes.rpy</code> and <code class="shell">WebQuotes.html</code> in your <code class="shell">~/public_html</code> directory, and you are ready to go.
</p>

<h2>Getting To It</h2>

<p>
There are three files involved in this example; <code class="shell">webquoteresource.py</code>, <code class="shell">WebQuotes.html</code>, and <code class="py-filename">webquotes.rpy</code>. <code class="shell">webquoteresource.py</code> is a normal python module and contains the class definition which will be used, a <code class="python">DOMTemplate</code> subclass. <code class="shell">WebQuotes.html</code> is placed in the web directory and is looked up at runtime by the <code class="python">DOMTemplate</code> machinery.  It is converted into a DOM tree which is iterated during page rendering. Finally, <code class="py-filename">webquotes.rpy</code> is placed in the web directory; each time the URL is visited, the file is executed; it <code class="python"><span class="py-src-keyword">import</span></code>s <code class="python">webquoteresource.QuoteResource</code> and instantiates it. This instance is asked to render the page.
</p>

<h3>webquoteresource.py</h3>

<p>
A <code class="python">DOMTemplate</code> subclass must do two things: specify a template, and provide methods to handle specific nodes in the template. The first simply requires either a <code class="python">template</code> attribute, which should be a string, or a <code class="python">templateFile</code> attribute, which should be a file name, specifying the XHTML template. To accomplish the second, we define methods with the prefix <code class="python">factory_</code> in our subclass. When the template is rendered, <code class="python">DOMTemplate</code> will look for the <code class="python">view</code> attribute on any HTML node. If one is found, the corresponding factory method will be called to handle the node.
</p>

<p>
<a href="listings/TwistedQuotes/webquoteresource.py" class="py-listing">Listing 1: webquoteresource.py: Twisted Quotes Web Resource module</a>
</p>

<h3>WebQuotes.html</h3>

<p>
In our example template, we insert a <code class="python">view</code> attribute onto the <code>&lt;title&gt;</code> node with the value <code class="py-src-string">'getTitle'</code>. We also insert a <code class="python">view</code> attribute on a <code>&lt;h1&gt;</code> node with the value <code class="py-src-string">'getTitle'</code>; this shows the ability of <code class="python">DOMTemplate</code> to reuse functionality while applying formatting defined by the template to the output. We also insert a <code class="python">view</code> attribute onto a <code>&lt;pre&gt;</code> node with the value <code class="py-src-string">'getQuote'</code>. This is where the real action will take place.
</p>

<p>
When the DOM is iterated and nodes with view attributes are found, <code class="python">DOMTemplate</code> will look in the instance's namespace for a method with the corresponding name, prefixed
by <code class="python">factory_</code>.
</p>

<a href="listings/TwistedQuotes/WebQuotes.xhtml" class="html-listing">Listing 2: WebQuotes.html: Twisted Quotes Web Template</a>

<h3>webquote.rpy</h3>

<p>
Finally, we need an <code class="shell">.rpy</code> file in the web directory that twisted can find and execute.  This is simply a matter of importing our module, instantiating our class, and assigning the instance to a variable named <code class="python">resource</code>. Twisted will discover this instance and call <code class="python">render</code> on it, causing the <code class="python">DOMTemplate</code> to be rendered.
</p>

<a href="listings/TwistedQuotes/webquote.rpy" class="py-listing">Listing 3: webquote.rpy: Twisted Quotes Web Application</a>

<p>
<a href="listings/TwistedQuotes/webquote.rpy">See it in action!</a>
</p>

<hr />
<address><a href="mailto:radix@twistedmatrix.com">Christopher Armstrong</a></address>
<!-- Created: Thu Jun 20 22:42:25 EDT 2002 -->
<!-- hhmts start -->
Last modified: Thu Jun 20 22:51:38 EDT 2002
<!-- hhmts end -->
</body>
</html>
