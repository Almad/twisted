<?xml version="1.0"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <title>Unit Tests in Twisted</title>
  </head>
  <body>
    <h1>Unit Tests in Twisted</h1>

    <p>Each <em>unit test</em> tests one bit of functionality in the
    software.  Unit tests are entirely automated and complete quickly.
    Unit tests for the entire system are gathered into one test suite,
    and may all be run in a single batch.  The result of a unit test
    is simple: either it passes, or it doesn't.  All this means you
    can test the entire system at any time without inconvenience, and
    quickly see what passes and what fails.</p>

    <h2>Unit Tests in the Twisted Philosophy</h2>

    <p>The Twisted development team
    adheres to the practice of <a href=
    "http://c2.com/cgi/wiki?ExtremeProgramming" >Extreme
    Programming</a> (XP), and the usage of unit tests is a cornerstone
    XP practice.  Unit tests are a tool to give you increased
    confidence.  You changed an algorithm -- did you break something?
    Run the unit tests.  If a test fails, you know where to look,
    because each test covers only a small amount of code, and you know
    it has something to do with the changes you just made.  If all the
    tests pass, you're good to go, and you don't need to second-guess
    yourself or worry that you just accidently broke someone else's
    program.</p>

    <h2>What to Test, What Not to Test</h2>

    <blockquote><p>You don't have to write a test for every single
    method you write, only production methods that could possibly break.</p>
    </blockquote>

    <p>-- Kent Beck, <cite>Extreme Programming Explained</cite>, p. 58.</p>

    <h2>Running the Tests</h2>

    <h3>How</h3>

    <pre class="shell">
$ Twisted/admin/runtests
    </pre>
    
    <p>You'll find that having something like this in your emacs init
    files is quite handy:</p>

<pre class="elisp">
(defun runtests () (interactive)
  (compile "python /somepath/Twisted/admin/runtests"))

(global-set-key [(alt t)] 'runtests)
</pre>
    <h3>When</h3>

    <p>Always always <em>always</em> be sure <a href=
     "http://www.xprogramming.com/xpmag/expUnitTestsAt100.htm">all the
     tests pass</a> before committing any code.  If someone else
     checks out code at the start of a development session and finds
     failing tests, they will not be happy and may decide to <em>hunt
     you down</em>.</p>

    <p>Since this is a geographically dispersed team, the person who
    can help you get your code working probably isn't in the room with
    you.  You may want to share your work in progress over the
    network, but you want to leave the main CVS tree in good working
    order.  So <a href=
    "http://www.cvshome.org/docs/manual/cvs_5.html" >use a branch</a>,
    and merge your changes back in only after your problem is solved
    and all the unit tests pass again.</p>

    <h2>Adding a Test</h2>

    <p>Please don't add new modules to Twisted without adding tests
    for them too.  Otherwise we could change something which breaks
    your module and not find out until later, making it hard to know
    exactly what the change that broke it was, or until after a
    release, and nobody wants broken code in a release.</p>

    <p>Tests go in Twisted/twisted/test/, and are named <code>test_foo.py</code>,
    where <code>foo</code> is the name of the module or package being tested.
    Extensive documentation on using the PyUnit framework for writing
    unit tests can be found in the <a href= "#links" >links
    section</a> below.</p>

    <p>One deviation from the standard PyUnit documentation: To ensure
    that any variations in test results are due to variations in the
    code or environment and not the test process itself, Twisted ships
    with its own, compatible, testing framework.  That just
    means that when you import the unittest module, you will <code
    class= "python" >from twisted.trial import unittest</code> instead of the
    standard <code class="python">import unittest</code>.</p>

    <p>As long as you have followed the module naming and placement
    conventions, <code class="shell">runtests</code> will be smart
    enough to pick up any new tests you write.</p>

<h2>Associating Test Cases With Source Files</h2>

<p>Please add a <code>test-case-name</code> tag to the source file that is
covered by your new test. This is a comment at the beginning of the file
which looks like one of the following:</p>

<pre class="python">
# -*- test-case-name: twisted.test.test_defer -*-
</pre>

<p>or</p>

<pre class="python">
#!/usr/bin/python
# -*- test-case-name: twisted.test.test_defer -*-
</pre>

<p>This format is understood by emacs to mark <q>File Variables</q>. The
intention is to accept <code>test-case-name</code> anywhere emacs would on
the first or second line of the file (but not in the <code>File
Variables:</code> block that emacs accepts at the end of the file). If you
need to define other emacs file variables, you can either put them in the
<code>File Variables:</code> block or use a semicolon-separated list of
variable definitions:</p>

<pre class="python">
# -*- test-case-name: twisted.test.test_defer; fill-column: 75; -*-
</pre>

<p>If the code is exercised by multiple test cases, those may be marked by
using a comma-separated list of tests, as follows: (NOTE: not all tools can
handle this yet.. trial --testmodule does, though)</p>

<pre class="python">
# -*- test-case-name: twisted.test.test_defer,twisted.test.test_tcp -*-
</pre>

<p>The <code>test-case-name</code> tag will allow <code class="shell">trial
--testmodule twisted/dir/myfile.py</code> to determine which test cases need
to be run to exercise the code in <code>myfile.py</code>. Several tools (as
well as <code>twisted-dev.el</code>'s F9 command) use this to automatically
run the right tests.</p>

    <h2 id="links">Links</h2><a name="links"></a>
    <ul>
      <li>A chapter on <a href=
      "http://diveintopython.org/roman_divein.html" >Unit Testing</a>
      in Mark Pilgrim's <a href="http://diveintopython.org">Dive Into
      Python</a>.</li>

      <li><a href=
      "http://www.python.org/doc/current/lib/module-unittest.html"
      ><code>unittest</code></a> module documentation, in the <a href=
      "http://www.python.org/doc/current/lib/" >Python Library
      Reference</a>.</li>

      <li><a href="http://c2.com/cgi/wiki?UnitTests">UnitTests</a> on
      the <a href="http://c2.com/cgi/wiki">PortlandPatternRepository
      Wiki</a>, where all the cool <a href=
      "http://c2.com/cgi/wiki?ExtremeProgramming"
      >ExtremeProgramming</a> kids hang out.</li>

      <li><a href=
      "http://www.extremeprogramming.org/rules/unittests.html" >Unit
      Tests</a> in <a href= "http://www.extremeprogramming.org"
      >Extreme Programming: A Gentle Introduction</a>.</li>

      <li>Ron Jeffries espouses on the importance of <a href=
      "http://www.xprogramming.com/xpmag/expUnitTestsAt100.htm" >Unit
      Tests at 100%</a>.</li>

      <li>Ron Jeffries writes about the <a href=
      "http://www.xprogramming.com/Practices/PracUnitTest.html" >Unit
      Test</a> in the <a href=
      "http://www.xprogramming.com/Practices/xpractices.htm" >Extreme
      Programming practices of C3</a>.</li>

      <li><a href="http://pyunit.sourceforge.net">PyUnit's homepage</a>.</li>

      <li><a href=
      "http://twistedmatrix.com/documents/TwistedDocs/current/api/public/toc-twisted.test-module.html"
      >twisted.test</a>'s inline documentation.</li>

      <li>The <a href=
      "http://twistedmatrix.com/users/jh.twistd/viewcvs/cgi/viewcvs.cgi/twisted/test/?cvsroot=Twisted"
      >twisted/test directory</a> in CVS.</li>

    </ul>
  </body>
</html>
